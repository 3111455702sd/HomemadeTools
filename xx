#!/bin/bash

GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
RED='\033[0;31m'
NC='\033[0m'

initialize_folders() {
    mkdir -p ./pak ./tools ./解包dat ./解包uexp ./打包dat ./打包uexp
}

main_menu() {
    clear
    echo -e "${BLUE}============================="
    echo -e "          ${YELLOW}和平精英美化制作工具${BLUE}         "
    echo -e "=============================${NC}"
    echo -e "${GREEN}1) PAK 解包${NC}"
    echo -e "${GREEN}2) PAK 打包${NC}"
    echo -e "${GREEN}3) 一键美化${NC}"
    echo -e "${GREEN}4) 退出${NC}"
    echo -e "${BLUE}=============================${NC}"

    read -p "请输入选项 (1-4): " choice
    case $choice in
        1) pak_unpack_menu ;;
        2) pak_pack_menu ;;
        3) beautify_menu ;;
        4) echo -e "${YELLOW}再见！${NC}"; exit 0 ;;
        *) echo -e "${RED}无效选项！请重新选择！${NC}"; sleep 1; main_menu ;;
    esac
}

get_pak_files() {
    pak_files=($(ls ./pak/*.pak 2>/dev/null))
    if [ ${#pak_files[@]} -eq 0 ]; then
        echo -e "${RED}当前没有 PAK 文件！${NC}"
        return 1
    fi
    for i in "${!pak_files[@]}"; do
        echo "$((i+1))) ${pak_files[i]##*/}"
    done
    return 0
}

pak_unpack_menu() {
    clear
    echo -e "${BLUE}======= PAK 解包 =======${NC}"
    get_pak_files
    if [ $? -eq 1 ]; then
        sleep 2; main_menu; return
    fi

    echo -e "${GREEN}选择解包方式:${NC}"
    echo -e "${GREEN}1)dat解包${NC}"
    echo -e "${GREEN}2)uexp解包${NC}"
    read -p "请输入选项 (1-2): " unpack_choice

    if [ "$unpack_choice" -eq 1 ]; then
        output_dir="./解包dat"
        echo -e "${YELLOW}正在使用 QuickBMS 解包到 ${output_dir}...${NC}"
        for pak_file in ./pak/*.pak; do
            echo -e "${GREEN}解包文件: ${pak_file##*/}${NC}"
            qemu-i386 ./tools/quickbms ./tools/解包.bms "$pak_file" "$output_dir"
        done
        sleep 2
        python3 ./tools/1
    elif [ "$unpack_choice" -eq 2 ]; then
        output_dir="./解包uexp"
        echo -e "${YELLOW}正在使用 URPack 解包到 ${output_dir}...${NC}"
        for pak_file in ./pak/*.pak; do
            echo -e "${GREEN}解包文件: ${pak_file##*/}${NC}"
            ./tools/urpack -a "$pak_file" "$output_dir"
        done
        sleep 2
        python3 ./tools/3
    else
        echo -e "${RED}无效选项！请重新选择！${NC}"
        sleep 1; pak_unpack_menu
    fi

    echo -e "${YELLOW}解包完成！${NC}"
    sleep 1; main_menu
}

pak_pack_menu() {
    clear
    echo -e "${BLUE}======= PAK 打包 =======${NC}"
    echo -e "${GREEN}选择打包方式:${NC}"
    echo -e "${GREEN}1) dat打包${NC}"
    echo -e "${GREEN}2) uexp打包${NC}"
    read -p "请输入选项 (1-2): " pack_choice

    if [ "$pack_choice" -eq 1 ]; then
        quickbms_pack
    elif [ "$pack_choice" -eq 2 ]; then
        urpack_pack
    else
        echo -e "${RED}无效选项！请重新选择！${NC}"
        sleep 1; pak_pack_menu
    fi
}

quickbms_pack() {
    input_dir="./打包dat"
    echo -e "${YELLOW}dat打包${NC}"
    
    pak_files=($(ls ./pak/*.pak 2>/dev/null))
    if [ ${#pak_files[@]} -eq 0 ]; then
        echo -e "${RED}PAK 文件夹中没有 PAK 文件！${NC}"
        sleep 2; main_menu; return
    fi
    
    for pak_file in "${pak_files[@]}"; do
        echo -e "${GREEN}正在打包: ${pak_file##*/}${NC}"
        qemu-i386 ./tools/quickbms -w -r ./tools/打包.bms "$pak_file" "$input_dir" &
        pid=$!
        while ps -p $pid > /dev/null; do
            sleep 1
        done
        sleep 2
    done

    echo -e "${YELLOW}打包完成！${NC}"
    read -n 1 -s
    main_menu
}

urpack_pack() {
    input_dir="./打包uexp"

    echo -e "${YELLOW}uexp打包${NC}"
    
    pak_files=($(ls ./pak/*.pak 2>/dev/null))
    if [ ${#pak_files[@]} -eq 0 ]; then
        echo -e "${RED}PAK 文件夹中没有 PAK 文件！${NC}"
        sleep 2; main_menu; return
    fi

    for pak_file in ./pak/*.pak; do
        echo -e "${GREEN}正在打包: ${pak_file##*/}${NC}"
        ./tools/urpack -a -r "$pak_file" "$input_dir"
        sleep 2
    done

    echo -e "${YELLOW}打包完成！${NC}"
    read -n 1 -s
    main_menu
}

beautify_menu() {
    clear
    echo -e "${BLUE}======= 一键美化 =======${NC}"
    echo -e "${GREEN}1) 载具美化${NC}"
    echo -e "${GREEN}2) 实体美化${NC}"
    echo -e "${GREEN}3) 返回主菜单${NC}"
    echo -e "${BLUE}========================${NC}"

    read -p "请输入选项 (1-3): " beautify_choice
    case $beautify_choice in
        1) 
            echo -e "${YELLOW}正在执行载具美化...${NC}"
            python3 ./tools/2
            ;;
        2) 
            echo -e "${YELLOW}正在执行实体美化...${NC}"
            python3 ./tools/5
            ;;
        3) main_menu ;;
        *) echo -e "${RED}无效选项！请重新选择！${NC}"; sleep 1; beautify_menu ;;
    esac
}

initialize_folders
main_menu